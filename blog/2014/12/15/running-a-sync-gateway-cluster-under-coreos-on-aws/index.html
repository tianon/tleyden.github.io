
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Running a Sync Gateway Cluster Under CoreOS on AWS - Seven Story Rabbit Hole</title>
  <meta name="author" content="Traun Leyden">

  
  <meta name="description" content="Follow the steps below to create a Sync Gateway + Couchbase Server cluster running under AWS with the following architecture: There is a youtube &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://tleyden.github.io/blog/2014/12/15/running-a-sync-gateway-cluster-under-coreos-on-aws">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Seven Story Rabbit Hole" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <header role="banner"><hgroup>

  <table><tr><td>
  <h1><a href="/">Seven Story Rabbit Hole</a></h1>
  
    <h2>Sometimes awesome things happen in deep rabbit holes.  Or not.</h2>
  
  </td><td>&nbsp;&nbsp;
  <img class="left" src="/images/rabbit_hole_graphic.png" width="132" height="105" title="image" alt="images">
  </td></tr>
  </table>

</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:tleyden.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Running a Sync Gateway Cluster Under CoreOS on AWS</h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-12-15T19:22:00-08:00" pubdate data-updated="true">Dec 15<span>th</span>, 2014</time>
        
      </p>
    
  </header>


<div class="entry-content"><p>Follow the steps below to create a Sync Gateway + Couchbase Server cluster running under AWS with the following architecture:</p>

<p><img src="http://tleyden-misc.s3.amazonaws.com/blog_images/sync-gw-coreos-onion.png" alt="architecture diagram" /></p>

<p>There is a <a href="https://www.youtube.com/watch?v=7-7jsLzHsWU">youtube video</a> (12 mins) which walks through this entire setup process, or you can follow the instructions below.</p>

<h2>Kick off Couchbase Server + Sync Gateway cluster</h2>

<h3>Launch EC2 instances</h3>

<p>Go to the <a href="https://console.aws.amazon.com/cloudformation/home?region=us-east-1#cstack=sn%7ECouchbase-CoreOS%7Cturl%7Ehttp://tleyden-misc.s3.amazonaws.com/couchbase-coreos/sync_gateway.template">Cloudformation Wizard</a></p>

<p>Recommended values:</p>

<ul>
<li><strong>ClusterSize</strong>: 3 nodes (default)</li>
<li><strong>Discovery URL</strong>:  as it says, you need to grab a new token from <a href="https://discovery.etcd.io/new">https://discovery.etcd.io/new</a> and paste it in the box.</li>
<li><strong>KeyPair</strong>: the name of the AWS keypair you want to use.  If you haven&rsquo;t already, you&rsquo;ll want to upload your local ssh key into AWS and create a named keypair.</li>
</ul>


<h3>ssh into a CoreOS instance</h3>

<p>Go to the AWS console under EC2 instances and find the public ip of one of your newly launched CoreOS instances.</p>

<p>Choose any one of them (it doesn&rsquo;t matter which), and ssh into it as the <strong>core</strong> user with the cert provided in the previous step:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ ssh -i aws.cer -A core@ec2-54-83-80-161.compute-1.amazonaws.com</span></code></pre></td></tr></table></div></figure>


<h2>Sanity check</h2>

<p>Let&rsquo;s make sure the CoreOS cluster is healthy first:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ fleetctl list-machines</span></code></pre></td></tr></table></div></figure>


<p>This should return a list of machines in the cluster, like this:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>MACHINE          IP              METADATA
</span><span class='line'>03b08680...     10.33.185.16    -
</span><span class='line'>209a8a2e...     10.164.175.9    -
</span><span class='line'>25dd84b7...     10.13.180.194   -</span></code></pre></td></tr></table></div></figure>


<h3>Kick off cluster</h3>

<p>From the CoreOS machine you ssh&rsquo;d into in the previous step:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ wget https://raw.githubusercontent.com/tleyden/sync-gateway-coreos/master/scripts/sync-gw-cluster-init.sh
</span><span class='line'>$ chmod +x sync-gw-cluster-init.sh
</span><span class='line'>$ SG_CONFIG_URL=https://gist.githubusercontent.com/tleyden/4ae1fe9b2b18783708cd/raw/fe4fb7f8637c1bf813c70e957bac35fa5ad28d01/sync_gw_config.json
</span><span class='line'>$ ./sync-gw-cluster-init.sh -n 1 -c master -b "todos" -z 512 -g $SG_CONFIG_URL -v 3.0.1 -m 3 -u user:passw0rd</span></code></pre></td></tr></table></div></figure>


<p>You&rsquo;ll want to use your own config URL for the SG_CONFIG_URL value.  For example, a file hosted in github or on your own webserver.</p>

<p>Parameters to sync-gw-cluster-init.sh:</p>

<ul>
<li><strong>-n</strong> &mdash; the number of sync gateway nodes to start.</li>
<li><strong>-c</strong> &mdash; the commit or branch name of sync gateway to use.</li>
<li><strong>-b</strong> &mdash; the couchbase bucket that should be created before starting sync gateway</li>
<li><strong>-z</strong> &mdash; the size of the bucket in MB to use for the bucket created via the <strong>-b</strong> param.</li>
<li><strong>-g</strong> &mdash; the url of the sync gateway config.</li>
<li><strong>-v</strong> &mdash; the version of couchbase server to launch (3.0.1 | 2.2.0)</li>
<li><strong>-m</strong> &mdash; the number of couchbase server nodes to launch.</li>
<li><strong>-u</strong> &mdash; the username and password in a single string separated by a colon.  You will want to customize this to use something sensical.</li>
</ul>


<h3>View cluster</h3>

<p>After the above script finishes, run <code>fleetctl list-units</code> to list the services in your cluster, and you should see:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>UNIT                     MACHINE             ACTIVE  SUB
</span><span class='line'>couchbase_bootstrap_node.service                281cd575.../10.150.73.56        active    running
</span><span class='line'>couchbase_bootstrap_node_announce.service       281cd575.../10.150.73.56        active    running
</span><span class='line'>couchbase_node.1.service                        36ab135c.../10.79.132.157       active    running
</span><span class='line'>couchbase_node.2.service                        f815a846.../10.51.179.214       active    running
</span><span class='line'>sync_gw_announce@1.service                      36ab135c.../10.79.132.157       active    running
</span><span class='line'>sync_gw_node@1.service                          36ab135c.../10.79.132.157       active    running</span></code></pre></td></tr></table></div></figure>


<p>They should all be in the <code>active</code> state.  If any are in the <code>activating</code> state &mdash; which is normal because it might take some time to download the docker image &mdash; then you should wait until they are all active before continuing.</p>

<h2>Verify internal</h2>

<p><strong>Find internal ip</strong></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ fleetctl list-units
</span><span class='line'>sync_gw_node.1.service                209a8a2e.../10.164.175.9    active  running</span></code></pre></td></tr></table></div></figure>


<p><strong>Curl</strong></p>

<p>On the CoreOS instance you are already ssh&rsquo;d into, Use the ip found above and run a curl request against the server root:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl 10.164.175.9:4984
</span><span class='line'>{"couchdb":"Welcome","vendor":{"name":"Couchbase Sync Gateway","version":1},"version":"Couchbase Sync Gateway/master(6356065)"}</span></code></pre></td></tr></table></div></figure>


<h2>Verify external</h2>

<p><strong>Find external ip</strong></p>

<p>Using the internal ip found above, go to the EC2 Instances section of the AWS console, and hunt around until you find the instance with that internal ip, and then get the public ip for that instance, eg: <code>ec2-54-211-206-18.compute-1.amazonaws.com</code></p>

<p><strong>Curl</strong></p>

<p>From your laptop, use the ip found above and run a curl request against the server root:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl ec2-54-211-206-18.compute-1.amazonaws.com:4984
</span><span class='line'>{"couchdb":"Welcome","vendor":{"name":"Couchbase Sync Gateway","version":1},"version":"Couchbase Sync Gateway/master(6356065)"}</span></code></pre></td></tr></table></div></figure>


<p>Congratulations!  You now have a Couchbase Server + Sync Gateway cluster running.</p>

<h2>Appendix A: Kicking off more Sync Gateway nodes.</h2>

<p>To launch two more Sync Gateway nodes, run the following command:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ fleetctl start sync_gw_node@{2..3}.service && fleetctl start sync_gw_announce@{2..3}.service</span></code></pre></td></tr></table></div></figure>


<h2>Appendix B: Setting up Elastic Load Balancer.</h2>

<p>Setup an Elastic Load Balancer with the following settings:</p>

<p><img src="http://tleyden-misc.s3.amazonaws.com/blog_images/sync_gateway_coreos_elb.png" alt="elb screenshot" /></p>

<p>Note that it forwards to <strong>port 4984</strong>.</p>

<p>Once the Load Balancer has been created, go to its configuration to get its DNS name:</p>

<p><img src="http://tleyden-misc.s3.amazonaws.com/blog_images/sync_gateway_coreos_elb2.png" alt="elb screenshot" /></p>

<p>Now you should be able to run curl against that:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl http://coreos-322270867.us-east-1.elb.amazonaws.com/
</span><span class='line'>{"couchdb":"Welcome","vendor":{"name":"Couchbase Sync Gateway","version":1},"version":"Couchbase Sync Gateway/master(b47aee8)"}</span></code></pre></td></tr></table></div></figure>


<p>What next?  You could try running <a href="https://github.com/couchbaselabs/GrocerySync-Android">GrocerySync-Android</a> or <a href="https://github.com/couchbaselabs/Grocery-Sync-iOS">GrocerySync-iOS</a> and pointing the Sync Gateway URL to your own Sync Gateway instance.</p>

<h2>References</h2>

<ul>
<li><a href="https://www.youtube.com/watch?v=7-7jsLzHsWU">youtube screencast</a> (12 mins)</li>
<li><a href="https://github.com/tleyden/sync-gateway-coreos">sync gateway Docker + CoreOS fleet files</a></li>
<li><a href="https://github.com/tleyden/couchbase-server-coreos">couchbase-server-coreos</a></li>
<li><a href="http://developer.couchbase.com/mobile/develop/guides/sync-gateway/nginx/index.html">Sync Gateway docs regarding reverse proxies</a></li>
<li><a href="https://groups.google.com/forum/?utm_medium=email&amp;utm_source=footer#!msg/mobile-couchbase/pXKQIAiCaW8/s9W_gSfRL50J">Couchbase Mobile Google Group discussion on ELB</a></li>
<li><a href="https://github.com/couchbase/sync_gateway">sync gateway</a></li>
</ul>

</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Traun Leyden</span></span>

      








  


<time datetime="2014-12-15T19:22:00-08:00" pubdate data-updated="true">Dec 15<span>th</span>, 2014</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/aws/'>aws</a>, <a class='category' href='/blog/categories/coreos/'>coreos</a>, <a class='category' href='/blog/categories/couchbase-mobile/'>couchbase-mobile</a>, <a class='category' href='/blog/categories/sync-gateway/'>sync-gateway</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="//twitter.com/share" class="twitter-share-button" data-url="http://tleyden.github.io/blog/2014/12/15/running-a-sync-gateway-cluster-under-coreos-on-aws/" data-via="tleydn" data-counturl="http://tleyden.github.io/blog/2014/12/15/running-a-sync-gateway-cluster-under-coreos-on-aws/" >Tweet</a>
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2014/12/11/up-and-running-with-couchbase-lite-phonegap/" title="Previous Post: Up and Running with Couchbase Lite Phonegap Android on OSX">&laquo; Up and Running with Couchbase Lite Phonegap Android on OSX</a>
      
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>About Me</h1>
  <p>
  I'm a software engineer at Couchbase, working on <a href="https://github.com/couchbase/couchbase-lite-android">Couchbase Lite for Android</a> -- a mobile NoSQL database with Sync.
  </p>

  <p>
  In my spare time I am working on <a href="http://www.openocr.net">OpenOCR</a> -- a Dockerized REST API wrapper for Tesseract OCR.
  </p>

</section>
<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2014/12/15/running-a-sync-gateway-cluster-under-coreos-on-aws/">Running a Sync Gateway Cluster Under CoreOS on AWS</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/12/11/up-and-running-with-couchbase-lite-phonegap/">Up and Running With Couchbase Lite Phonegap Android on OSX</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/12/02/getting-started-with-go-and-protocol-buffers/">Getting Started With Go and Protocol Buffers</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/11/14/running-cbfs/">Running a CBFS Cluster on CoreOS</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/11/12/an-example-of-using-nsq-from-go/">An Example of Using NSQ From Go</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/tleyden">@tleyden</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'tleyden',
            count: 5,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>

<section>
     <h1>Twitter</h1>
<a class="twitter-timeline" width="300" height="350" href="https://twitter.com/tleydn" data-widget-id="376419812865368064">Tweets by @tleydn</a>
<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+"://platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>

 </section>

  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2015 - Traun Leyden -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'sevenstoryrabbithole';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://tleyden.github.io/blog/2014/12/15/running-a-sync-gateway-cluster-under-coreos-on-aws/';
        var disqus_url = 'http://tleyden.github.io/blog/2014/12/15/running-a-sync-gateway-cluster-under-coreos-on-aws/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
